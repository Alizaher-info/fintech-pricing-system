# Makefile fÃ¼r pricing-api gRPC Service
# Portfolio Finance - Go Microservice

.PHONY: proto clean build run test docker-build docker-run docker-stop help

# Variablen
SERVICE_NAME = pricing-api
PROTO_PATH = ../../protos
MODULE_NAME = pricingapi
DOCKER_COMPOSE_PATH = ../../deploy/compose

# Standard Target
help:
	@echo "=== Pricing API - Make Commands ==="
	@echo "proto        - Generiere Protobuf-Dateien"
	@echo "build        - Baue Go Binary lokal"
	@echo "run          - Starte Service lokal"
	@echo "test         - FÃ¼hre Tests aus"
	@echo "clean        - LÃ¶sche generierte Dateien"
	@echo "docker-build - Baue Docker Image"
	@echo "docker-run   - Starte Docker Container"
	@echo "docker-stop  - Stoppe Docker Container"
	@echo "docker-logs  - Zeige Docker Logs"

# Protobuf Generierung
proto:
	@echo "ğŸ”§ Generiere Protobuf-Dateien..."
	@if not exist "gen\pricing\v1" mkdir gen\pricing\v1
	protoc --proto_path=$(PROTO_PATH) \
		--go_out=. --go_opt=module=$(MODULE_NAME) \
		--go-grpc_out=. --go-grpc_opt=module=$(MODULE_NAME) \
		pricing/v1/pricing.proto
	@echo "âœ… Protobuf-Dateien erfolgreich generiert!"

# AufrÃ¤umen
clean:
	@echo "ğŸ§¹ LÃ¶sche generierte Dateien..."
	@if exist "gen" rmdir /s /q gen
	@if exist "$(SERVICE_NAME).exe" del $(SERVICE_NAME).exe
	@if exist "$(SERVICE_NAME)" del $(SERVICE_NAME)
	@echo "âœ… AufgerÃ¤umt!"

# Dependencies laden
deps:
	@echo "ğŸ“¦ Lade Go Dependencies..."
	go mod download
	go mod tidy
	@echo "âœ… Dependencies geladen!"

# Build binary lokal
build: proto deps
	@echo "ğŸ”¨ Baue $(SERVICE_NAME)..."
	go build -o $(SERVICE_NAME).exe
	@echo "âœ… Build erfolgreich!"

# Tests ausfÃ¼hren
test:
	@echo "ğŸ§ª FÃ¼hre Tests aus..."
	go test ./...
	@echo "âœ… Tests abgeschlossen!"

# Service lokal laufen lassen
run: build
	@echo "ğŸš€ Starte $(SERVICE_NAME) lokal..."
	./$(SERVICE_NAME).exe

# Docker Commands
docker-build:
	@echo "ğŸ³ Baue Docker Image..."
	cd $(DOCKER_COMPOSE_PATH) && docker-compose build $(SERVICE_NAME)
	@echo "âœ… Docker Image gebaut!"

docker-run:
	@echo "ğŸ³ Starte Docker Container..."
	cd $(DOCKER_COMPOSE_PATH) && docker-compose up $(SERVICE_NAME) -d
	@echo "âœ… Docker Container gestartet!"

docker-stop:
	@echo "ğŸ³ Stoppe Docker Container..."
	cd $(DOCKER_COMPOSE_PATH) && docker-compose stop $(SERVICE_NAME)
	@echo "âœ… Docker Container gestoppt!"

docker-logs:
	@echo "ğŸ“‹ Docker Logs:"
	cd $(DOCKER_COMPOSE_PATH) && docker-compose logs $(SERVICE_NAME)

# VollstÃ¤ndiger Docker Rebuild
docker-rebuild: clean
	@echo "ğŸ”„ VollstÃ¤ndiger Docker Rebuild..."
	cd $(DOCKER_COMPOSE_PATH) && docker-compose build --no-cache $(SERVICE_NAME)
	@echo "âœ… Docker Rebuild abgeschlossen!"

# Entwicklungsworkflow
dev: clean proto build run

# Deployment workflow  
deploy: clean docker-build docker-run
	@echo "ğŸ‰ Deployment abgeschlossen!"